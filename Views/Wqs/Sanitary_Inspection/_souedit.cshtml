@model List<Wq_Surveillance.Models.SourceSanitary>
@{
    var mainFormId = ViewData["uuid"] as string;
}

<div class="row">
    <div class="col-12 col-lg-8 m-auto">
        <div class="multisteps-form__form">
            <div class="multisteps-form__panel shadow p-4 rounded bg-white js-active">
                <h3 class="multisteps-form__title">Source Forms</h3>
                <div class="multisteps-form__content">
                    @foreach (var source in Model)
                    {
                        <div class="form-container mb-4 p-3 border rounded">
                            <form class="sanitaryForm" method="post" onsubmit="updateSourceData(event)">
                                @Html.AntiForgeryToken()

                                <!-- Main Form Identifier -->
                                <input type="hidden" name="FormId" value="@mainFormId" />

                                <!-- Individual Source Form Identifier -->
                                <input type="hidden" asp-for="@source.Uuid" name="Uuid" />

                                <div style="background-color: #eee; margin-top:10px">
                                    <h7>Source Details (@source.Uuid)</h7>
                                </div>

                                <table class="table table-borderless" style="width:90%;">
                                    <tr>
                                        <td>मुहान क्षेत्रमा रुख बिरुवा...</td>
                                        <td>
                                            <select class="form-control"
                                                    asp-for="@source.SourceSanitationCondition1"
                                                    name="SourceSanitationCondition1">
                                                <option value="छ">छ</option>
                                                <option value="छैन">छैन</option>
                                                <option value="आंसिक रुपमा छ">आंसिक रुपमा छ</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            खुल्ला दिसा पिसाब को कारण मुहान क्षेत्रमा जैविक प्रदूषणको संभावना
                                        </td>
                                        <td>
                                            <select class="form-control" asp-for="@source.SourceSanitationCondition2" name="SourceSanitationCondition2">
                                                <option value="छ">छ</option>
                                                <option value="छैन">छैन</option>
                                                <option value="आंसिक रुपमा छ">आंसिक रुपमा छ</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            मुहान वरिपरि ढलको अभावमा जमिनको प्रदुषित पानी को प्रवेश
                                        </td>
                                        <td>
                                            <select class="form-control" asp-for="@source.SourceSanitationCondition3" name="SourceSanitationCondition3">
                                                <option value="छ">छ</option>
                                                <option value="छैन">छैन</option>
                                                <option value="आंसिक रुपमा छ">आंसिक रुपमा छ</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            अनावश्यक मानिस तथा जनावरको मुहान क्षेत्रमा सजीलै पहुच
                                        </td>
                                        <td>
                                            <select class="form-control" asp-for="@source.SourceSanitationCondition4" name="SourceSanitationCondition4">
                                                <option value="छ">छ</option>
                                                <option value="छैन">छैन</option>
                                                <option value="आंसिक रुपमा छ">आंसिक रुपमा छ</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            मुहान क्षेत्रमा सरसफाइको कमिले गर्दा प्रदूषण को सम्भावना
                                        </td>
                                        <td>
                                            <select class="form-control" asp-for="@source.SourceSanitationCondition5" name="SourceSanitationCondition5">
                                                <option value="छ">छ</option>
                                                <option value="छैन">छैन</option>
                                                <option value="आंसिक रुपमा छ">आंसिक रुपमा छ</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            मुहान क्षेत्रमा रुख बिरुवा नभएकोले बाढि पहिरोले मुहानमा प्रदूषण को सम्भावना भएको
                                        </td>
                                        <td>
                                            <select class="form-control" asp-for="@source.SourceSanitationCondition6" name="SourceSanitationCondition6">
                                                <option value="छ">छ</option>
                                                <option value="छैन">छैन</option>
                                                <option value="आंसिक रुपमा छ">आंसिक रुपमा छ</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            खुल्ला दिसा पिसाब को कारण मुहान क्षेत्रमा जैविक प्रदूषण को संभावना
                                        </td>
                                        <td>
                                            <select class="form-control" asp-for="@source.SourceSanitationCondition7" name="SourceSanitationCondition7">
                                                <option value="छ">छ</option>
                                                <option value="छैन">छैन</option>
                                                <option value="आंसिक रुपमा छ">आंसिक रुपमा छ</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            पानीको मुहानमा खोला बाट पानी तर्काउदा अत्याधिक ठोस फोहर तथा धमीलोपनाको नियन्त्रणको अभाव
                                        </td>
                                        <td>
                                            <select class="form-control" asp-for="@source.SourceSanitationCondition8" name="SourceSanitationCondition8">
                                                <option value="छ">छ</option>
                                                <option value="छैन">छैन</option>
                                                <option value="आंसिक रुपमा छ">आंसिक रुपमा छ</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <!-- Repeat similar structure for other fields -->
                                </table>

                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-primary">Save</button>
                                    <button type="button" class="btn btn-danger"
                                            onclick="deleteSanitaryData('@mainFormId', '@source.Uuid')">
                                        Delete
                                    </button>
                                </div>
                            </form>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function updateSourceData(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        fetch('/Wqs/FormSanSouEditPost', {
            method: 'POST',
            body: formData,
            headers: {
                'RequestVerificationToken': form.querySelector('[name="__RequestVerificationToken"]').value
            }
        })
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Successfully updated!');
                    // Optional: Update UI without refresh
                    form.querySelector('.btn-primary').textContent = '✔ Saved';
                    setTimeout(() => {
                        form.querySelector('.btn-primary').textContent = 'Save';
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Update failed');
                }
            })
            .catch(error => {
                alert(error.message);
                console.error('Error:', error);
            });
    }

    function deleteSanitaryData(mainFormId, sourceUuid) {
        if (!confirm('Permanently delete this source form?')) return;

        const payload = {
            mainFormId: btoa(unescape(encodeURIComponent(mainFormId))),
            sourceUuid: btoa(unescape(encodeURIComponent(sourceUuid)))
        };

        fetch('/Wqs/DeleteSourceForm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
            },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Deleted successfully!');
                    window.location.reload(); // Refresh to reflect changes
                } else {
                    throw new Error(data.message || 'Deletion failed');
                }
            })
            .catch(error => {
                alert(error.message);
                console.error('Error:', error);
            });
    }
</script>